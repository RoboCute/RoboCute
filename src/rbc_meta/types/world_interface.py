from rbc_meta.utils.reflect import reflect
from rbc_meta.utils.builtin import DataBuffer, ExternalType
from rbc_meta.utils.builtin import (
    uint,
    uint2,
    ulong,
    float3,
    float4x4,
    VoidPtr,
    GUID,
    double,
    double3,
    float4,
    double4x4,
    Vector,
    RC,
    RCBase,
)
from rbc_meta.types.resource_enums import LCPixelStorage
from enum import Enum


@reflect(cpp_namespace="rbc", module_name="world_interface", pybind=True)
class ResourceLoadStatus(Enum):
    Unloaded = 0
    Loading = 1
    Loaded = 2
    Installing = 3
    Installed = 4


@reflect(cpp_namespace="rbc", module_name="world_interface", pybind=True)
class BaseObjectType(Enum):
    NONE = 0
    Component = 1
    Entity = 2
    Resource = 3
    Custom = 4


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
    create_instance=False,
)
class Object:
    def guid() -> GUID: ...
    def type_name() -> str: ...
    def type_id() -> GUID: ...
    def base_type() -> BaseObjectType: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class Entity(Object):
    def add_component(name: str) -> VoidPtr: ...
    def get_component(name: str) -> VoidPtr: ...
    def remove_component(name: str) -> bool: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
    create_instance=False,
)
class Component(Object):
    def entity() -> Entity: ...
    def update_data() -> None: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
    create_instance=False,
)
class TransformComponent(Component):
    def position() -> double3: ...
    def scale() -> double3: ...
    def rotation() -> float4: ...
    def trs() -> double4x4: ...
    def trs_float() -> float4x4: ...
    def children_count() -> ulong: ...
    def remove_children(children: VoidPtr) -> bool: ...
    def set_pos(pos: double3, recursive: bool) -> None: ...
    def set_scale(scale: double3, recursive: bool) -> None: ...
    def set_rotation(rotation: float4, recursive: bool) -> None: ...
    def set_trs_matrix(trs: double4x4, recursive: bool) -> None: ...
    def set_trs(
        pos: double3, rotation: float4, scale: double3, recursive: bool
    ) -> None: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
    create_instance=False,
)
class LightComponent(Component):
    def add_area_light(luminance: float3, visible: bool) -> None: ...
    def add_disk_light(luminance: float3, visible: bool) -> None: ...
    def add_point_light(luminance: float3, visible: bool) -> None: ...
    def add_spot_light(
        luminance: float3,
        angle_radians: float,
        small_angle_radians: float,
        angle_atten_pow: float,
        visible: bool,
    ) -> None: ...

    def luminance() -> float3: ...
    def angle_radians() -> float: ...
    def small_angle_radians() -> float: ...
    def angle_atten_pow() -> float: ...


# Resources


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
    create_instance=False,
)
class Resource(Object):
    def load_status() -> ResourceLoadStatus: ...
    def load() -> None: ...
    def install() -> bool: ...
    def path() -> str: ...
    def save_to_path() -> bool: ...
    def wait_loading() -> None: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class TextureResource(Resource):
    def is_vt() -> bool: ...
    def pack_to_tile() -> bool: ...
    def pixel_storage() -> LCPixelStorage: ...
    def size() -> uint2: ...
    def mip_level() -> uint: ...

    def create_empty(
        pixel_storage: LCPixelStorage,
        size: uint2,
        mip_level: uint,
        is_virtual_texture: bool,
    ) -> None: ...
    def load_executed() -> bool: ...
    def has_data_buffer() -> bool: ...
    def data_buffer() -> DataBuffer: ...
    def heap_index() -> uint: ...
    def set_skybox() -> None: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class MeshResource(Resource):
    def vertex_count() -> uint: ...
    def triangle_count() -> uint: ...
    def uv_count() -> uint: ...
    def submesh_count() -> uint: ...
    def is_transforming_mesh() -> bool: ...
    def contained_normal() -> bool: ...
    def data_buffer() -> DataBuffer: ...
    def contained_tangent() -> bool: ...
    def has_data_buffer() -> bool: ...
    def data_buffer() -> DataBuffer: ...
    def basic_size_bytes() -> ulong: ...
    def extra_size_bytes() -> ulong: ...
    def desire_size_bytes() -> ulong: ...

    def create_empty(
        submesh_offsets: DataBuffer,
        vertex_count: uint,
        triangle_count: uint,
        uv_count: uint,
        contained_normal: bool,
        contained_tangent: bool,
    ) -> None: ...

    def create_as_morphing_instance(origin_mesh: "MeshResource") -> None: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class MaterialResource(Resource):
    def mat_code() -> uint: ...
    def load_from_json(json: str) -> None: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
    create_instance=False,
)
class RenderComponent(Component):
    def get_tlas_index() -> uint: ...
    def remove_object() -> None: ...
    def update_object(mat_vector: Vector[RC[RCBase]], mesh: MeshResource) -> None: ...

    def update_mesh(mesh: MeshResource) -> None: ...
    def update_material(mat_vector: Vector[RC[RCBase]]) -> None: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class CameraComponent(Component):
    def fov() -> double: ...
    def set_fov(value: double) -> None: ...
    def aspect_ratio() -> double: ...
    def set_aspect_ratio(value: double) -> None: ...
    def near_plane() -> double: ...
    def set_near_plane(value: double) -> None: ...
    def far_plane() -> double: ...
    def set_far_plane(value: double) -> None: ...
    def aperture() -> double: ...
    def set_aperture(value: double) -> None: ...
    def enable_physical_camera() -> bool: ...
    def set_enable_physical_camera(value: bool) -> None: ...
    def focus_distance() -> double: ...
    def set_focus_distance(value: double) -> None: ...
    def auto_aspect_ratio() -> double: ...
    def set_auto_aspect_ratio(value: double) -> None: ...

    def enable_camera() -> None: ...
    def disable_camera() -> None: ...
    def save_image_to(path: str) -> None: ...


# Import, load and manage project


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class EntitiesCollection:
    def count() -> ulong: ...
    def get_entity(index: ulong) -> Entity: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class Scene(Resource):
    def get_entity(guid: GUID) -> Entity: ...
    def get_or_add_entity(guid: GUID) -> Entity: ...
    def update_data() -> None: ...
    def remove_entity(guid: GUID) -> None: ...
    def get_entity_by_name(name: str) -> Entity: ...
    def get_entities_by_name(name: str) -> EntitiesCollection: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class FileMeta:
    def guid() -> GUID: ...
    def meta_json() -> str: ...


@reflect(
    pybind=True,
    cpp_prefix="TEST_GRAPHICS_API",
    cpp_namespace="rbc",
    module_name="world_interface",
)
class Project:
    def init(assets_root_dir: str) -> None: ...
    def import_texture(path: str, extra_meta: str) -> None: ...
    def import_mesh(path: str, extra_meta: str) -> None: ...
    def import_material(path: str, extra_meta: str) -> None: ...
    def import_scene(path: str, extra_meta: str) -> Scene: ...
    # TODO: more import
    def load_resource(guid: GUID, async_load: bool) -> TextureResource: ...

    def scan_project() -> None: ...
    def get_file_meta(type_id: GUID, dest_path: str) -> FileMeta: ...
